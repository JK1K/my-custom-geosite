name: Build Custom Geosite

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 4'

# Explicitly grant write permission to the token
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout upstream v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: ./source

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Prepare Data and Resolve Dependencies
        run: |
          mkdir -p ./data-temp
          
          python3 -c "
          import os
          import shutil
          
          # --- YOUR CONFIGURATION ---
          wanted_roots = [
              'category-ru',
              'category-gov-ru',
              'category-media-ru',
              'category-retail-ru',
              'category-ecommerce-ru',
              'category-entertainment-ru',
              'vk',
              'avito',
              'mailru-group',
              'x5',
              'yandex',
              'openai',
              'google',
              'category-ads-all'
          ]
          # --------------------------

          source_dir = './source/data'
          target_dir = './source/data-new'
          os.makedirs(target_dir, exist_ok=True)

          processed_files = set()
          queue = list(wanted_roots)

          print('--- Starting Dependency Resolution ---')

          while queue:
              current_file = queue.pop(0)
              if current_file in processed_files:
                  continue
                  
              src_path = os.path.join(source_dir, current_file)
              
              if not os.path.exists(src_path):
                  print(f'WARNING: File not found: {current_file}')
                  continue

              shutil.copy(src_path, os.path.join(target_dir, current_file))
              processed_files.add(current_file)
              print(f'Included: {current_file}')

              try:
                  with open(src_path, 'r', encoding='utf-8') as f:
                      lines = f.readlines()
                      for line in lines:
                          line = line.strip()
                          if line.startswith('include:'):
                              dependency = line.split(':')[1].strip()
                              if dependency and dependency not in processed_files:
                                  queue.append(dependency)
              except Exception as e:
                  print(f'Error reading {current_file}: {e}')

          print(f'--- Finished. Total files included: {len(processed_files)} ---')
          "

          rm -rf ./source/data
          mv ./source/data-new ./source/data

      - name: Build geosite.dat
        run: |
          cd ./source
          go run ./ --outputdir=../
        
      - name: Rename output
        run: mv dlc.dat geosite.dat

      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          files: geosite.dat
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          # Removed the invalid 'update_latest_release' line
