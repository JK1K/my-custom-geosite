name: Build Custom Dat Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 4'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # =========================================================
      # 1. BUILD GEOSITE.DAT
      # =========================================================
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: ./geosite-src

      - name: Prepare Geosite Data
        run: |
          mkdir -p ./geosite-src/data-temp
          
          python3 -c "
          import os
          import shutil
          
          # --- YOUR GEOSITE CONFIGURATION ---
          wanted_roots = [
              'category-ru',
              'category-gov-ru',
              'category-media-ru',
              'category-retail-ru',
              'category-ecommerce-ru',
              'category-entertainment-ru',
              'vk',
              'avito',
              'mailru-group',
              'x5',
              'yandex',
              'openai',
              'google',
              'telegram',
              'whatsapp',
              'category-ads-all'
          ]
          # ----------------------------------

          source_dir = './geosite-src/data'
          target_dir = './geosite-src/data-new'
          os.makedirs(target_dir, exist_ok=True)

          processed_files = set()
          queue = list(wanted_roots)

          print('--- Starting Geosite Dependency Resolution ---')

          while queue:
              current_file = queue.pop(0)
              if current_file in processed_files:
                  continue
                  
              src_path = os.path.join(source_dir, current_file)
              
              if not os.path.exists(src_path):
                  print(f'WARNING: File not found: {current_file}')
                  continue

              shutil.copy(src_path, os.path.join(target_dir, current_file))
              processed_files.add(current_file)
              
              try:
                  with open(src_path, 'r', encoding='utf-8') as f:
                      for line in f:
                          line = line.strip()
                          if line.startswith('include:'):
                              dependency = line.split(':')[1].strip()
                              if dependency and dependency not in processed_files:
                                  queue.append(dependency)
              except Exception as e:
                  print(f'Error reading {current_file}: {e}')

          print(f'--- Finished. Total geosite files: {len(processed_files)} ---')
          "

          rm -rf ./geosite-src/data
          mv ./geosite-src/data-new ./geosite-src/data

      - name: Build geosite.dat
        run: |
          cd ./geosite-src
          go run ./ --outputdir=../
          cd ..
          mv dlc.dat geosite.dat

      # =========================================================
      # 2. BUILD GEOIP.DAT
      # =========================================================
      - name: Checkout v2fly/geoip
        uses: actions/checkout@v4
        with:
          repository: v2fly/geoip
          path: ./geoip-src

      - name: Generate Custom GeoIP Config
        run: |
          # We create a config that takes Loyalsoldier's full file as INPUT,
          # and outputs a file containing only the tags we want.
          
          cat > ./geoip-src/config.json <<EOF
          {
            "input": [
              {
                "type": "v2rayGeoIPDat",
                "action": "add",
                "args": {
                  "uri": "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat",
                  "wantedList": [
                    "ru",
                    "google",
                    "telegram",
                    "private"
                  ]
                }
              }
            ],
            "output": [
              {
                "type": "v2rayGeoIPDat",
                "action": "output",
                "args": {
                  "outputName": "geoip.dat",
                  "outputDir": "../"
                }
              }
            ]
          }
          EOF
          
          # NOTE: 
          # 1. 'ru' covers VK, Yandex, Avito, Mail.ru IPs.
          # 2. 'google' is explicitly available in Loyalsoldier's list.
          # 3. 'openai' is NOT a standard geoip tag; it will fall under US or Cloudflare IPs.
          # 4. 'private' is good for local network exclusion.

      - name: Build geoip.dat
        run: |
          cd ./geoip-src
          go run ./
          # The config outputs to ../geoip.dat, so it ends up in the root workspace

      # =========================================================
      # 3. RELEASE BOTH
      # =========================================================
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          files: |
            geosite.dat
            geoip.dat
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
