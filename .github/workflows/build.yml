name: Build Custom Dat Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 4'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT

      # =========================================================
      # 1. BUILD GEOSITE.DAT
      # =========================================================
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: ./geosite-src

      - name: Prepare Geosite Data
        run: |
          python3 -c "
          import os
          import shutil
          import re

          # --- CONFIGURATION ---
          wanted_roots = [
              'category-ru',
              'category-gov-ru',
              'category-media-ru',
              'category-retail-ru',
              'category-ecommerce-ru',
              'category-entertainment-ru',
              'vk',
              'avito',
              'mailru-group',
              'x5',
              'yandex',
              'openai',
              'google',
              'category-ads-all'
          ]
          # ---------------------

          source_dir = './geosite-src/data'
          target_dir = './geosite-src/data-new'
          os.makedirs(target_dir, exist_ok=True)

          processed_files = set()
          queue = list(wanted_roots)

          print('--- Starting Robust Dependency Resolution ---')

          while queue:
              current_file = queue.pop(0)
              if current_file in processed_files:
                  continue
              
              src_path = os.path.join(source_dir, current_file)
              
              if not os.path.exists(src_path):
                  print(f'  [!] Skip: {current_file} (not found in source)')
                  continue

              shutil.copy(src_path, os.path.join(target_dir, current_file))
              processed_files.add(current_file)
              print(f'  [+] Copied: {current_file}')

              try:
                  with open(src_path, 'r', encoding='utf-8') as f:
                      for line in f:
                          line = line.strip()
                          # Match 'include:filename' and ignore anything after @ or space
                          if line.startswith('include:'):
                              # Extract the part after 'include:'
                              dep_part = line[8:].strip()
                              # Split by space or @ to get only the filename
                              # e.g., 'google @ads' -> 'google'
                              dep_filename = re.split(r'[\s@]', dep_part)[0]
                              
                              if dep_filename and dep_filename not in processed_files:
                                  queue.append(dep_filename)
              except Exception as e:
                  print(f'  [!] Error reading {current_file}: {e}')

          print(f'--- Finished. Total files: {len(processed_files)} ---')
          "

          # Swap the directories
          rm -rf ./geosite-src/data
          mv ./geosite-src/data-new ./geosite-src/data

      - name: Build geosite.dat
        run: |
          cd ./geosite-src
          go run ./ --outputdir=../
          cd ..
          mv dlc.dat geosite.dat

      # =========================================================
      # 2. BUILD GEOIP.DAT
      # =========================================================
      - name: Checkout v2fly/geoip
        uses: actions/checkout@v4
        with:
          repository: v2fly/geoip
          path: ./geoip-src

      - name: Generate Custom GeoIP Config
        run: |
          cat > ./geoip-src/config.json <<EOF
          {
            "input": [
              {
                "type": "v2rayGeoIPDat",
                "action": "add",
                "args": {
                  "uri": "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat",
                  "wantedList": ["ru", "google", "telegram", "private"]
                }
              }
            ],
            "output": [
              {
                "type": "v2rayGeoIPDat",
                "action": "output",
                "args": {
                  "outputName": "geoip.dat",
                  "outputDir": "../"
                }
              }
            ]
          }
          EOF

      - name: Build geoip.dat
        run: |
          cd ./geoip-src
          go run ./

      # =========================================================
      # 3. GENERATE CHECKSUMS
      # =========================================================
      - name: Generate SHA256 Checksums
        run: |
          sha256sum geosite.dat > geosite.dat.sha256sum
          sha256sum geoip.dat > geoip.dat.sha256sum

      # =========================================================
      # 4. RELEASE
      # =========================================================
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.date.outputs.date }}
          name: "Release ${{ steps.date.outputs.date }}" # Sets a nice title
          files: |
            geosite.dat
            geosite.dat.sha256sum
            geoip.dat
            geoip.dat.sha256sum
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          make_latest: true # Explicitly tells GitHub this is the new 'Latest'
